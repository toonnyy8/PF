<!doctype html>
<html>

<head>
    <meta charset="utf-8">
    <script src="./include.js"></script>
    <title>Pixel Fighter--NEW TEST</title>
</head>

<body style="background-color:#000000;">
    <!--<script>
        {
            /*******************************************
                非同步式wasm調用
            *******************************************/

            let fetchAndInstantiateWasm = function(url, imports) {
                const {
                    webFrame
                } = require('electron');
                webFrame.registerURLSchemeAsPrivileged('file');

                return fetch(url) // url could be your .wasm file
                    .then(res => {
                        if (res.ok) {
                            return res.arrayBuffer();
                        } else {
                            throw new Error(`Unable to fetch Web Assembly file ${url}.`);
                        }
                    })
                    .then(bytes => WebAssembly.compile(bytes))
                    .then(module => {
                        imports = imports || {};
                        imports.env = imports.env || {};
                        imports.env.memoryBase = imports.env.memoryBase || 0;
                        imports.env.tableBase = imports.env.tableBase || 0;
                        if (!imports.env.memory) {
                            imports.env.memory = new WebAssembly.Memory({
                                initial: 256,
                            });
                        }
                        if (!imports.env.table) {
                            imports.env.table = new WebAssembly.Table({
                                initial: 0,
                                element: 'anyfunc'
                            });
                        }
                        return WebAssembly.instantiate(module, imports || {});
                    })
                    .then(instance => instance.exports);
            }
            let testst = false;
            fetchAndInstantiateWasm('./add.wasm', {})
                .then(m => {
                    window.add = m.add;
                    console.log(m.add(50, 10));
                    testst = true;
                });
            let A = function(__fun__, async_finish) {
                setTimeout(function() {
                    if (async_finish()) {
                        __fun__();
                    } else {
                        A(__fun__, async_finish);
                    }
                }, 1);
            };
            A(
                function() {
                    console.log(add(50, 5000));
                },
                function() {
                    return testst;
                }
            );
            fetchAndInstantiateWasm('./C2Wasm/test.wasm', {})
                .then(m => {
                    console.log(m._test()); //用Emscripten 編譯生成的函數，會有 _作前綴，像test變 _test
                });
        }

        {
            /*******************************************
                同步式wasm調用
            *******************************************/
            let path = "./resources/app/include/newtest";
            let WebAssembly_Loader = function(url, imports) {
                let fs = require("fs");
                let wasm_code = fs.readFileSync(url);
                //console.log(wasm_code);
                imports = imports || {};
                imports.env = imports.env || {};
                imports.env.memoryBase = imports.env.memoryBase || 0;
                imports.env.tableBase = imports.env.tableBase || 0;
                if (!imports.env.memory) {
                    imports.env.memory = new WebAssembly.Memory({
                        initial: 256,
                    });
                }
                if (!imports.env.table) {
                    imports.env.table = new WebAssembly.Table({
                        initial: 0,
                        element: 'anyfunc'
                    });
                }
                return WebAssembly.Instance(WebAssembly.Module(wasm_code), imports).exports;
            }

            console.log(WebAssembly_Loader("./resources/app/include/newtest/test.wasm").aaa(17, 8));
            let test = new WebAssembly_Loader("./resources/app/include/newtest/test.wasm");
            console.log(test.aaa(2, 3));
            console.log(WebAssembly_Loader(path + "/C2Wasm/test.wasm")._test());

        }
    </script>-->
    <script>
        keyboardJS.bind("esc", function() {
            window.location.href = "../../start.html";
        });
    </script>

    <script>
        const ipcRenderer = require('electron').ipcRenderer;
        keyboardJS.bind('f11', function() {
            ipcRenderer.send('full-screen');
        });
        keyboardJS.bind('f12', function() {
            ipcRenderer.send('DevTools');
        });
    </script>
    <script>
    </script>
</body>

</html>